
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>üìå Conclusiones del modelo de regresi√≥n KNN &#8212; Project Dropout and Academic Success</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=720ed60b" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/basic.css?v=d2032c04" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=720ed60b" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/styles/bootstrap.css?v=b4a3e8ba" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/styles/theme.css?v=a243ae73" />
    <link rel="stylesheet" type="text/css" href="_static/vendor/fontawesome/6.5.2/css/all.min.css?v=f4fbef65" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'regresion';</script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/copybutton_funcs.js?v=776a791e"></script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/language_data.js?v=d4673a71"></script>
    <script src="_static/searchtools.js?v=63a53a7d"></script>
    <script src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script src="_static/scripts/bootstrap.js?v=7583a70d"></script>
    <script src="_static/scripts/pydata-sphinx-theme.js?v=4bc35cb3"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?v=4e4fcec4"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/logo.png" class="logo__image only-light" alt="Project Dropout and Academic Success - Home"/>
    <script>document.write(`<img src="_static/logo.png" class="logo__image only-dark" alt="Project Dropout and Academic Success - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="intro.html">
                    An√°lisis Exploratorio de Datos
                </a>
            </li>
        </ul>
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="docs/markdown.html">Markdown Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="docs/markdown-notebooks.html">Notebooks with MyST Markdown</a></li>
<li class="toctree-l1"><a class="reference internal" href="minproyect_1.html">ENTREGA DEL MINIPROYECTO #1</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2Fregresion.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/regresion.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>

</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>üìå Conclusiones del modelo de regresi√≥n KNN</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ===========================</span>
<span class="c1"># KNN Regresi√≥n con CV manual 5-fold</span>
<span class="c1"># - One-Hot Encoding y escalado DENTRO del fold (evita data leakage)</span>
<span class="c1"># - Prueba k = 1..20</span>
<span class="c1"># - Usa tu lista de columnas categ√≥ricas</span>
<span class="c1"># ===========================</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">median_absolute_error</span>

<span class="c1"># 1) Cargar datos</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="c1"># 2) Variable objetivo (promedio de notas 1er y 2do semestre)</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Final_Average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span>
    <span class="s2">&quot;Curricular units 1st sem (grade)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (grade)&quot;</span>
<span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 3) Eliminar columnas con fuga de datos (2¬∞ semestre + Target + y)</span>
<span class="n">cols_to_exclude</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Target&quot;</span><span class="p">,</span> <span class="s2">&quot;Final_Average&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (grade)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (approved)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (evaluations)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (credited)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (enrolled)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (without evaluations)&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">X_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_to_exclude</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">y_full</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Final_Average&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># 4) Tus columnas categ√≥ricas (id√©nticas a clasificaci√≥n)</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Marital status&#39;</span><span class="p">,</span> <span class="s1">&#39;Application mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Application order&#39;</span><span class="p">,</span> <span class="s1">&#39;Course&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Daytime/evening attendance&#39;</span><span class="p">,</span> <span class="s1">&#39;Previous qualification&#39;</span><span class="p">,</span> <span class="s1">&#39;Nacionality&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Mother&#39;s qualification&quot;</span><span class="p">,</span> <span class="s2">&quot;Father&#39;s qualification&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mother&#39;s occupation&quot;</span><span class="p">,</span> <span class="s2">&quot;Father&#39;s occupation&quot;</span><span class="p">,</span> <span class="s1">&#39;Displaced&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Educational special needs&#39;</span><span class="p">,</span> <span class="s1">&#39;Debtor&#39;</span><span class="p">,</span> <span class="s1">&#39;Tuition fees up to date&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="s1">&#39;Scholarship holder&#39;</span><span class="p">,</span> <span class="s1">&#39;International&#39;</span>
<span class="p">]</span>
<span class="c1"># Usar solo las que existan (por si alg√∫n nombre difiere en tu CSV)</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categorical_columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_full</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="c1"># 5) Columnas num√©ricas CONTINUAS (antes de OHE) que se escalar√°n por fold</span>
<span class="n">numeric_columns_pre_ohe</span> <span class="o">=</span> <span class="n">X_full</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">numeric_columns_pre_ohe</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">numeric_columns_pre_ohe</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categorical_columns</span><span class="p">]</span>

<span class="c1"># 6) Configuraci√≥n de CV manual y estructura de resultados</span>
<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
<span class="n">k_values</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">cv_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;RMSE&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;MAE&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;R2&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;MedAE&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;MAPE&quot;</span><span class="p">:</span> <span class="p">[]}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">}</span>

<span class="c1"># 7) Loop de CV manual: OHE + Escalado DENTRO del fold</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">tr_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_full</span><span class="p">):</span>
        <span class="n">X_tr_raw</span> <span class="o">=</span> <span class="n">X_full</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">tr_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X_val_raw</span> <span class="o">=</span> <span class="n">X_full</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">y_tr</span> <span class="o">=</span> <span class="n">y_full</span><span class="p">[</span><span class="n">tr_idx</span><span class="p">]</span>
        <span class="n">y_val</span> <span class="o">=</span> <span class="n">y_full</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>

        <span class="c1"># --- One-Hot Encoding SOLO con las columnas categ√≥ricas (ajustado con train del fold)</span>
        <span class="n">X_tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_tr_raw</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X_val</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_val_raw</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Alinear validaci√≥n a las columnas del train (categor√≠as faltantes = 0)</span>
        <span class="n">X_val</span> <span class="o">=</span> <span class="n">X_val</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">X_tr</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># --- Escalar SOLO num√©ricas continuas disponibles tras OHE (fit con train del fold)</span>
        <span class="n">cols_to_scale_fold</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">numeric_columns_pre_ohe</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_tr</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">X_tr</span><span class="p">[</span><span class="n">cols_to_scale_fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_tr</span><span class="p">[</span><span class="n">cols_to_scale_fold</span><span class="p">])</span>
        <span class="n">X_val</span><span class="p">[</span><span class="n">cols_to_scale_fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_val</span><span class="p">[</span><span class="n">cols_to_scale_fold</span><span class="p">])</span>

        <span class="c1"># --- Modelo y predicci√≥n</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>

        <span class="c1"># --- M√©tricas del fold</span>
        <span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
        <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">r2</span>  <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">medae</span> <span class="o">=</span> <span class="n">median_absolute_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-8</span>  <span class="c1"># para evitar divisi√≥n por cero en MAPE</span>
        <span class="n">mape</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">y_val</span> <span class="o">-</span> <span class="n">y_pred</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">y_val</span><span class="p">)</span> <span class="o">+</span> <span class="n">eps</span><span class="p">)))</span> <span class="o">*</span> <span class="mi">100</span>

        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MAE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mae</span><span class="p">)</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;R2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MedAE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">medae</span><span class="p">)</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MAPE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mape</span><span class="p">)</span>

<span class="c1"># 8) Resumen por k (promedios de los 5 folds) y selecci√≥n por RMSE</span>
<span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">:</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s2">&quot;RMSE_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;RMSE_std&quot;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;MAE_mean&quot;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MAE&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;R2_mean&quot;</span><span class="p">:</span>   <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;R2&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;MedAE_mean&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MedAE&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;MAPE_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MAPE&quot;</span><span class="p">]),</span>
    <span class="p">})</span>

<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;RMSE_mean&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===== Resumen CV 5-fold (ordenado por RMSE promedio) =====&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="n">best_k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;k&quot;</span><span class="p">])</span>
<span class="n">best_rmse</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;RMSE_mean&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">‚úÖ Mejor k por RMSE promedio: </span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2"> (RMSE=</span><span class="si">{</span><span class="n">best_rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===== Resumen CV 5-fold (ordenado por RMSE promedio) =====
 k  RMSE_mean  RMSE_std  MAE_mean  R2_mean  MedAE_mean    MAPE_mean
 9   1.679730  0.081842  1.039846 0.876763    0.654618 9.856182e+08
10   1.683860  0.080594  1.044105 0.876197    0.653193 1.053562e+09
 8   1.685886  0.083990  1.042982 0.875783    0.665716 9.450206e+08
11   1.690423  0.076802  1.048292 0.875310    0.657615 1.120849e+09
12   1.695597  0.077277  1.051116 0.874539    0.651718 1.178630e+09
14   1.699056  0.073439  1.055706 0.874157    0.652816 1.279126e+09
 7   1.699449  0.083413  1.045644 0.873799    0.673733 8.956994e+08
15   1.699449  0.074223  1.057275 0.874103    0.656791 1.316259e+09
13   1.700043  0.072951  1.054299 0.873983    0.653949 1.232105e+09
 6   1.702812  0.081453  1.048806 0.873304    0.686029 8.272390e+08
16   1.706492  0.075274  1.063328 0.873017    0.661321 1.365893e+09
17   1.710037  0.077267  1.067538 0.872447    0.660355 1.418513e+09
18   1.711986  0.079757  1.068762 0.872127    0.656632 1.460683e+09
19   1.713291  0.080118  1.073236 0.871909    0.662583 1.506967e+09
 5   1.715610  0.083794  1.058148 0.871294    0.689208 7.894048e+08
20   1.719774  0.080651  1.077861 0.870949    0.655880 1.550667e+09
 4   1.747551  0.081404  1.071508 0.866482    0.680326 7.636795e+08
 3   1.799277  0.087363  1.096721 0.858385    0.667989 6.747743e+08
 2   1.896798  0.092675  1.145691 0.842769    0.669771 5.865577e+08
 1   2.187129  0.105772  1.283670 0.791198    0.726662 5.916522e+08

‚úÖ Mejor k por RMSE promedio: 9 (RMSE=1.6797)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ============================================</span>
<span class="c1"># KNN REGRESI√ìN con Holdout Externo + CV manual (5-fold)</span>
<span class="c1"># - Objetivo: Final_Average (promedio 1er y 2¬∫ semestre)</span>
<span class="c1"># - Anti data leakage: OHE y escalado dentro de cada fold</span>
<span class="c1"># - Selecci√≥n de k (1..20) por RMSE promedio en CV</span>
<span class="c1"># - Evaluaci√≥n final en test externo (20%)</span>
<span class="c1"># ============================================</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">KFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">median_absolute_error</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 1) Cargar datos</span>
<span class="c1"># --------------------------</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 2) Variable objetivo (promedio de 1er y 2¬∫ semestre)</span>
<span class="c1"># --------------------------</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Final_Average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span>
    <span class="s2">&quot;Curricular units 1st sem (grade)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (grade)&quot;</span>
<span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 3) Evitar fuga de datos: eliminar TODO lo del 2¬∫ semestre + Target + la propia y</span>
<span class="c1"># --------------------------</span>
<span class="n">cols_to_exclude</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Target&quot;</span><span class="p">,</span> <span class="s2">&quot;Final_Average&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (grade)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (approved)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (evaluations)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (credited)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (enrolled)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (without evaluations)&quot;</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">X_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_to_exclude</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">y_full</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Final_Average&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 4) Tus columnas categ√≥ricas (id√©nticas a clasificaci√≥n)</span>
<span class="c1"># --------------------------</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Marital status&#39;</span><span class="p">,</span> <span class="s1">&#39;Application mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Application order&#39;</span><span class="p">,</span> <span class="s1">&#39;Course&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Daytime/evening attendance&#39;</span><span class="p">,</span> <span class="s1">&#39;Previous qualification&#39;</span><span class="p">,</span> <span class="s1">&#39;Nacionality&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Mother&#39;s qualification&quot;</span><span class="p">,</span> <span class="s2">&quot;Father&#39;s qualification&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mother&#39;s occupation&quot;</span><span class="p">,</span> <span class="s2">&quot;Father&#39;s occupation&quot;</span><span class="p">,</span> <span class="s1">&#39;Displaced&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Educational special needs&#39;</span><span class="p">,</span> <span class="s1">&#39;Debtor&#39;</span><span class="p">,</span> <span class="s1">&#39;Tuition fees up to date&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="s1">&#39;Scholarship holder&#39;</span><span class="p">,</span> <span class="s1">&#39;International&#39;</span>
<span class="p">]</span>
<span class="c1"># Usar solo las que existan en X_full (por si hay diferencias de nombres)</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categorical_columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_full</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 5) Columnas num√©ricas continuas (antes de OHE); NO incluir categ√≥ricas</span>
<span class="c1"># --------------------------</span>
<span class="n">numeric_columns_pre_ohe</span> <span class="o">=</span> <span class="n">X_full</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">numeric_columns_pre_ohe</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">numeric_columns_pre_ohe</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categorical_columns</span><span class="p">]</span>

<span class="c1"># ======================================================</span>
<span class="c1"># 6) HOLDOUT EXTERNO (20%) para evaluaci√≥n final</span>
<span class="c1"># ======================================================</span>
<span class="n">X_train_full</span><span class="p">,</span> <span class="n">X_test_holdout</span><span class="p">,</span> <span class="n">y_train_full</span><span class="p">,</span> <span class="n">y_test_holdout</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_full</span><span class="p">,</span> <span class="n">y_full</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># ======================================================</span>
<span class="c1"># 7) CV manual (5-fold) en el 80% de entrenamiento para elegir k</span>
<span class="c1">#    OHE y escalado DENTRO del fold (anti-leakage)</span>
<span class="c1"># ======================================================</span>
<span class="n">k_values</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">cv_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;RMSE&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;MAE&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;R2&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;MedAE&quot;</span><span class="p">:</span> <span class="p">[]}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">}</span>

<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">tr_idx</span><span class="p">,</span> <span class="n">val_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_train_full</span><span class="p">):</span>
        <span class="n">X_tr_raw</span> <span class="o">=</span> <span class="n">X_train_full</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">tr_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X_val_raw</span> <span class="o">=</span> <span class="n">X_train_full</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">y_tr</span> <span class="o">=</span> <span class="n">y_train_full</span><span class="p">[</span><span class="n">tr_idx</span><span class="p">]</span>
        <span class="n">y_val</span> <span class="o">=</span> <span class="n">y_train_full</span><span class="p">[</span><span class="n">val_idx</span><span class="p">]</span>

        <span class="c1"># --- One-Hot Encoding solo con las categ√≥ricas (ajustado con train del fold)</span>
        <span class="n">X_tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_tr_raw</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X_val</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_val_raw</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Alinear columnas de validaci√≥n a las del train (categor√≠as faltantes = 0)</span>
        <span class="n">X_val</span> <span class="o">=</span> <span class="n">X_val</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">X_tr</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># --- Escalado SOLO en num√©ricas continuas presentes tras OHE (fit con train del fold)</span>
        <span class="n">cols_to_scale_fold</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">numeric_columns_pre_ohe</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_tr</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">X_tr</span><span class="p">[</span><span class="n">cols_to_scale_fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_tr</span><span class="p">[</span><span class="n">cols_to_scale_fold</span><span class="p">])</span>
        <span class="n">X_val</span><span class="p">[</span><span class="n">cols_to_scale_fold</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_val</span><span class="p">[</span><span class="n">cols_to_scale_fold</span><span class="p">])</span>

        <span class="c1"># --- Modelo y predicci√≥n</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_val</span><span class="p">)</span>

        <span class="c1"># --- M√©tricas del fold</span>
        <span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
        <span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">r2</span>  <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">medae</span> <span class="o">=</span> <span class="n">median_absolute_error</span><span class="p">(</span><span class="n">y_val</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rmse</span><span class="p">)</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MAE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mae</span><span class="p">)</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;R2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MedAE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">medae</span><span class="p">)</span>

<span class="c1"># --- Resumen por k y selecci√≥n por RMSE promedio</span>
<span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">:</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s2">&quot;RMSE_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;RMSE_std&quot;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;MAE_mean&quot;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MAE&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;R2_mean&quot;</span><span class="p">:</span>   <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;R2&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;MedAE_mean&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MedAE&quot;</span><span class="p">]),</span>
    <span class="p">})</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;RMSE_mean&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===== Resumen CV 5-fold en TRAIN (ordenado por RMSE promedio) =====&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="n">best_k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;k&quot;</span><span class="p">])</span>
<span class="n">best_rmse</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;RMSE_mean&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">‚úÖ Mejor k por RMSE promedio (CV en train): </span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2"> (RMSE=</span><span class="si">{</span><span class="n">best_rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># ======================================================</span>
<span class="c1"># 8) Entrenamiento FINAL en TODO el 80% (train_full) con best_k</span>
<span class="c1">#    y evaluaci√≥n en el HOLDOUT EXTERNO (20%) ‚Äî sin fugas</span>
<span class="c1"># ======================================================</span>

<span class="c1"># --- OHE en train_full y test_holdout usando las mismas columnas del train</span>
<span class="n">X_train_ohe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_train_full</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_test_ohe</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_test_holdout</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Alinear test a las columnas de train (faltantes = 0)</span>
<span class="n">X_test_ohe</span> <span class="o">=</span> <span class="n">X_test_ohe</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">X_train_ohe</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># --- Escalado con par√°metros AJUSTADOS SOLO en train_full</span>
<span class="n">cols_to_scale_final</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">numeric_columns_pre_ohe</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_train_ohe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">scaler_final</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">X_train_ohe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_test_scaled</span>  <span class="o">=</span> <span class="n">X_test_ohe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="n">X_train_scaled</span><span class="p">[</span><span class="n">cols_to_scale_final</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler_final</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[</span><span class="n">cols_to_scale_final</span><span class="p">])</span>
<span class="n">X_test_scaled</span><span class="p">[</span><span class="n">cols_to_scale_final</span><span class="p">]</span>  <span class="o">=</span> <span class="n">scaler_final</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">[</span><span class="n">cols_to_scale_final</span><span class="p">])</span>

<span class="c1"># --- Modelo final y m√©tricas en holdout externo</span>
<span class="n">knn_final</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">best_k</span><span class="p">)</span>
<span class="n">knn_final</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_full</span><span class="p">)</span>
<span class="n">y_pred_test</span> <span class="o">=</span> <span class="n">knn_final</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="n">mse_test</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">,</span> <span class="n">y_pred_test</span><span class="p">)</span>
<span class="n">rmse_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse_test</span><span class="p">)</span>
<span class="n">mae_test</span>  <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">,</span> <span class="n">y_pred_test</span><span class="p">)</span>
<span class="n">r2_test</span>   <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">,</span> <span class="n">y_pred_test</span><span class="p">)</span>
<span class="n">medae_test</span> <span class="o">=</span> <span class="n">median_absolute_error</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">,</span> <span class="n">y_pred_test</span><span class="p">)</span>

<span class="c1"># R¬≤ ajustado en test: n = obs de test, p = n¬∫ de predictores</span>
<span class="n">n_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">X_test_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">r2_adj_test</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r2_test</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_test</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_test</span> <span class="o">-</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">===== M√©tricas en HOLDOUT EXTERNO (20%) =====&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMSE:    </span><span class="si">{</span><span class="n">rmse_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAE:     </span><span class="si">{</span><span class="n">mae_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R¬≤:      </span><span class="si">{</span><span class="n">r2_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R¬≤_adj:  </span><span class="si">{</span><span class="n">r2_adj_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MedAE:   </span><span class="si">{</span><span class="n">medae_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===== Resumen CV 5-fold en TRAIN (ordenado por RMSE promedio) =====
 k  RMSE_mean  RMSE_std  MAE_mean  R2_mean  MedAE_mean
 8   1.699206  0.027630  1.054130 0.874195    0.670791
 9   1.700738  0.030459  1.056765 0.873982    0.659344
10   1.700751  0.029324  1.057884 0.874034    0.649848
11   1.701074  0.022036  1.059829 0.873964    0.636945
 7   1.705818  0.026141  1.056755 0.873234    0.689052
13   1.706670  0.018902  1.068118 0.873207    0.659298
12   1.707412  0.021673  1.062821 0.873013    0.645268
16   1.708865  0.013953  1.073470 0.872959    0.674978
14   1.710717  0.013977  1.071778 0.872646    0.661326
17   1.713130  0.011751  1.078210 0.872335    0.672045
15   1.714662  0.012336  1.076244 0.872073    0.677318
 6   1.716504  0.033356  1.059863 0.871575    0.679683
18   1.717232  0.007974  1.080895 0.871849    0.668324
19   1.719497  0.011367  1.082333 0.871519    0.661837
 5   1.727544  0.034021  1.066015 0.869929    0.680512
20   1.727761  0.018437  1.086901 0.870380    0.666470
 4   1.746472  0.022864  1.076429 0.867237    0.690893
 3   1.796817  0.027634  1.107182 0.859445    0.691120
 2   1.888046  0.031959  1.155614 0.845038    0.710839
 1   2.122718  0.093066  1.267973 0.803517    0.731613

‚úÖ Mejor k por RMSE promedio (CV en train): 8 (RMSE=1.6992)

===== M√©tricas en HOLDOUT EXTERNO (20%) =====
RMSE:    1.7889
MAE:     1.1016
R¬≤:      0.8610
R¬≤_adj:  0.8116
MedAE:   0.6909
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># ============================</span>
<span class="c1"># 1) Tomar las m√©tricas desde variables existentes o usar fallback con tus n√∫meros</span>
<span class="c1"># ============================</span>
<span class="k">try</span><span class="p">:</span>
    <span class="c1"># Si ya tienes summary_df (CV) y las m√©tricas de test (holdout) en variables:</span>
    <span class="c1"># best_k = 8  # asegura k=8 si hace falta</span>
    <span class="n">row_cv</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rmse_cv</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row_cv</span><span class="p">[</span><span class="s1">&#39;RMSE_mean&#39;</span><span class="p">])</span>
    <span class="n">mae_cv</span>   <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row_cv</span><span class="p">[</span><span class="s1">&#39;MAE_mean&#39;</span><span class="p">])</span>
    <span class="n">r2_cv</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row_cv</span><span class="p">[</span><span class="s1">&#39;R2_mean&#39;</span><span class="p">])</span>
    <span class="n">medae_cv</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">row_cv</span><span class="p">[</span><span class="s1">&#39;MedAE_mean&#39;</span><span class="p">])</span>

    <span class="n">rmse_test</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rmse_test</span><span class="p">)</span>
    <span class="n">mae_test</span>   <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mae_test</span><span class="p">)</span>
    <span class="n">r2_test</span>    <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">r2_test</span><span class="p">)</span>
    <span class="n">medae_test</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">medae_test</span><span class="p">)</span>

<span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="c1"># Fallback con tus valores reportados</span>
    <span class="n">rmse_cv</span><span class="p">,</span> <span class="n">mae_cv</span><span class="p">,</span> <span class="n">r2_cv</span><span class="p">,</span> <span class="n">medae_cv</span> <span class="o">=</span> <span class="mf">1.6992</span><span class="p">,</span> <span class="mf">1.0541</span><span class="p">,</span> <span class="mf">0.8742</span><span class="p">,</span> <span class="mf">0.6708</span>
    <span class="n">rmse_test</span><span class="p">,</span> <span class="n">mae_test</span><span class="p">,</span> <span class="n">r2_test</span><span class="p">,</span> <span class="n">medae_test</span> <span class="o">=</span> <span class="mf">1.7889</span><span class="p">,</span> <span class="mf">1.1016</span><span class="p">,</span> <span class="mf">0.8610</span><span class="p">,</span> <span class="mf">0.6909</span>

<span class="c1"># ============================</span>
<span class="c1"># 2) Construir la tabla comparativa y diferencias</span>
<span class="c1"># ============================</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;M√©trica&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;RMSE&quot;</span><span class="p">,</span> <span class="s2">&quot;MAE&quot;</span><span class="p">,</span> <span class="s2">&quot;R¬≤&quot;</span><span class="p">,</span> <span class="s2">&quot;MedAE&quot;</span><span class="p">],</span>
    <span class="s2">&quot;CV (promedio 5 folds, k=8)&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">rmse_cv</span><span class="p">,</span> <span class="n">mae_cv</span><span class="p">,</span> <span class="n">r2_cv</span><span class="p">,</span> <span class="n">medae_cv</span><span class="p">],</span>
    <span class="s2">&quot;Test externo (holdout 20%, k=8)&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">rmse_test</span><span class="p">,</span> <span class="n">mae_test</span><span class="p">,</span> <span class="n">r2_test</span><span class="p">,</span> <span class="n">medae_test</span><span class="p">],</span>
<span class="p">}</span>
<span class="n">df_comp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">df_comp</span><span class="p">[</span><span class="s2">&quot;Diferencia (Test - CV)&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_comp</span><span class="p">[</span><span class="s2">&quot;Test externo (holdout 20%, k=8)&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df_comp</span><span class="p">[</span><span class="s2">&quot;CV (promedio 5 folds, k=8)&quot;</span><span class="p">]</span>

<span class="c1"># Mostrar tabla en consola</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Comparaci√≥n CV vs Test externo ===&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_comp</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">float_format</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span>


<span class="c1"># ============================</span>
<span class="c1"># 3) Gr√°fico comparativo (barras lado a lado)</span>
<span class="c1"># ============================</span>
<span class="n">metrics</span> <span class="o">=</span> <span class="n">df_comp</span><span class="p">[</span><span class="s2">&quot;M√©trica&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">cv_vals</span> <span class="o">=</span> <span class="n">df_comp</span><span class="p">[</span><span class="s2">&quot;CV (promedio 5 folds, k=8)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">test_vals</span> <span class="o">=</span> <span class="n">df_comp</span><span class="p">[</span><span class="s2">&quot;Test externo (holdout 20%, k=8)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">metrics</span><span class="p">))</span>
<span class="n">width</span> <span class="o">=</span> <span class="mf">0.35</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">cv_vals</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;CV (5 folds)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">test_vals</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Test externo&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">metrics</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Valor&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;KNN Regresi√≥n ‚Äî Comparaci√≥n CV vs Test externo (k=8)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Comparaci√≥n CV vs Test externo ===
M√©trica  CV (promedio 5 folds, k=8)  Test externo (holdout 20%, k=8)  Diferencia (Test - CV)
   RMSE                      1.6992                           1.7889                  0.0897
    MAE                      1.0541                           1.1016                  0.0474
     R¬≤                      0.8742                           0.8610                 -0.0132
  MedAE                      0.6708                           0.6909                  0.0201
</pre></div>
</div>
<img alt="_images/9b1d5d94cd54260ab312f447f1a2d247e2dce2b9bd88605f96ea4986e652efd8.png" src="_images/9b1d5d94cd54260ab312f447f1a2d247e2dce2b9bd88605f96ea4986e652efd8.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># --- Entrenar y graficar SIN data leakage (usa el holdout externo) ---</span>

<span class="c1"># Asegura que best_k exista; si no, toma el mejor del summary_df</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">best_k</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="n">best_k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;k&quot;</span><span class="p">])</span>

<span class="c1"># Entrena SOLO con el conjunto de entrenamiento completo (80%)</span>
<span class="n">best_knn</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">best_k</span><span class="p">)</span>
<span class="n">best_knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_full</span><span class="p">)</span>

<span class="c1"># Predice en el HOLDOUT (20%) ‚Äî datos nunca vistos en CV</span>
<span class="n">y_pred_holdout</span> <span class="o">=</span> <span class="n">best_knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="c1"># Gr√°fico Predicho vs Real (HOLDOUT)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">,</span> <span class="n">y_pred_holdout</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">y_test_holdout</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test_holdout</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
         <span class="p">[</span><span class="n">y_test_holdout</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test_holdout</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Valor real&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Valor predicho&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Predicci√≥n vs Real para K = </span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2"> (Test externo)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/471497409cb30132ca98b90adb4623d8d233b784254c8b9dc24e45b937780250.png" src="_images/471497409cb30132ca98b90adb4623d8d233b784254c8b9dc24e45b937780250.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># --- Entrenar modelo FINAL en el 80% (train_full) con el k √≥ptimo ---</span>
<span class="c1"># (opcional: prueba weights=&quot;distance&quot; si quieres dar m√°s peso a vecinos cercanos)</span>
<span class="n">final_knn</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">best_k</span><span class="p">)</span>
<span class="n">final_knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_full</span><span class="p">)</span>

<span class="c1"># --- Predecir en el HOLDOUT EXTERNO (20%) ---</span>
<span class="n">y_pred_final</span> <span class="o">=</span> <span class="n">final_knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="c1"># 1) Gr√°fico Real vs Predicho (holdout)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">,</span> <span class="n">y_pred_final</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">y_test_holdout</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test_holdout</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span>
         <span class="p">[</span><span class="n">y_test_holdout</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test_holdout</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Valor real&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Valor predicho&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üìà Real vs Predicho (k=</span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2">) ‚Äî Test externo&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 2) Distribuci√≥n de errores (residuos) en holdout</span>
<span class="n">residuals</span> <span class="o">=</span> <span class="n">y_test_holdout</span> <span class="o">-</span> <span class="n">y_pred_final</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;üìâ Distribuci√≥n de errores (residuos) ‚Äî Test externo&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Error (real - predicho)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frecuencia&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 3) Distribuci√≥n del error absoluto en holdout</span>
<span class="n">abs_errors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">residuals</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">abs_errors</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;üìä Distribuci√≥n del error absoluto ‚Äî Test externo&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;|Error|&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frecuencia&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\migue\AppData\Local\Temp\ipykernel_20736\2074621796.py:22: UserWarning: Glyph 128200 (\N{CHART WITH UPWARDS TREND}) missing from current font.
  plt.tight_layout()
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\pylabtools.py:152: UserWarning: Glyph 128200 (\N{CHART WITH UPWARDS TREND}) missing from current font.
  fig.canvas.print_figure(bytes_io, **kw)
</pre></div>
</div>
<img alt="_images/8b561464f0a1753f5034ba6024653f5d79194cf7fd3834c9bdae605c81659656.png" src="_images/8b561464f0a1753f5034ba6024653f5d79194cf7fd3834c9bdae605c81659656.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\migue\AppData\Local\Temp\ipykernel_20736\2074621796.py:34: UserWarning: Glyph 128201 (\N{CHART WITH DOWNWARDS TREND}) missing from current font.
  plt.tight_layout()
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\pylabtools.py:152: UserWarning: Glyph 128201 (\N{CHART WITH DOWNWARDS TREND}) missing from current font.
  fig.canvas.print_figure(bytes_io, **kw)
</pre></div>
</div>
<img alt="_images/601e45040661b5de78732a486298937064ad34b22d78d036e1f598e21f7b33b1.png" src="_images/601e45040661b5de78732a486298937064ad34b22d78d036e1f598e21f7b33b1.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\migue\AppData\Local\Temp\ipykernel_20736\2074621796.py:45: UserWarning: Glyph 128202 (\N{BAR CHART}) missing from current font.
  plt.tight_layout()
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\pylabtools.py:152: UserWarning: Glyph 128202 (\N{BAR CHART}) missing from current font.
  fig.canvas.print_figure(bytes_io, **kw)
</pre></div>
</div>
<img alt="_images/6ab217cecf755100dec331bfabc7294155cb3252713a495448d91fd9ed590b27.png" src="_images/6ab217cecf755100dec331bfabc7294155cb3252713a495448d91fd9ed590b27.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==============================================</span>
<span class="c1"># KNN Regresi√≥n ‚Äî CV 5-fold (k=1..20) + Holdout 20% (sin fugas)</span>
<span class="c1"># ==============================================</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span><span class="p">,</span> <span class="n">KFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">median_absolute_error</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 1) Cargar datos</span>
<span class="c1"># --------------------------</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 2) Variable objetivo: promedio 1er y 2¬∫ semestre</span>
<span class="c1"># --------------------------</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Final_Average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span>
    <span class="s2">&quot;Curricular units 1st sem (grade)&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Curricular units 2nd sem (grade)&quot;</span>
<span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 3) Evitar fuga: eliminar TODO 2¬∫ semestre + Target + la propia y</span>
<span class="c1"># --------------------------</span>
<span class="n">cols_to_exclude</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Target&quot;</span><span class="p">,</span> <span class="s2">&quot;Final_Average&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (grade)&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Curricular units 2nd sem (approved)&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Curricular units 2nd sem (evaluations)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (credited)&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Curricular units 2nd sem (enrolled)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (without evaluations)&quot;</span>
<span class="p">]</span>
<span class="n">X_full</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_to_exclude</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">y_full</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Final_Average&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 4) Categ√≥ricas (tu lista) y num√©ricas pre-OHE</span>
<span class="c1"># --------------------------</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Marital status&#39;</span><span class="p">,</span> <span class="s1">&#39;Application mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Application order&#39;</span><span class="p">,</span> <span class="s1">&#39;Course&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Daytime/evening attendance&#39;</span><span class="p">,</span> <span class="s1">&#39;Previous qualification&#39;</span><span class="p">,</span> <span class="s1">&#39;Nacionality&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Mother&#39;s qualification&quot;</span><span class="p">,</span> <span class="s2">&quot;Father&#39;s qualification&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mother&#39;s occupation&quot;</span><span class="p">,</span> <span class="s2">&quot;Father&#39;s occupation&quot;</span><span class="p">,</span> <span class="s1">&#39;Displaced&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Educational special needs&#39;</span><span class="p">,</span> <span class="s1">&#39;Debtor&#39;</span><span class="p">,</span> <span class="s1">&#39;Tuition fees up to date&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="s1">&#39;Scholarship holder&#39;</span><span class="p">,</span> <span class="s1">&#39;International&#39;</span>
<span class="p">]</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categorical_columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_full</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="n">numeric_columns_pre_ohe</span> <span class="o">=</span> <span class="n">X_full</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span><span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">numeric_columns_pre_ohe</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">numeric_columns_pre_ohe</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categorical_columns</span><span class="p">]</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 5) HOLDOUT externo 20%</span>
<span class="c1"># --------------------------</span>
<span class="n">X_train_full</span><span class="p">,</span> <span class="n">X_test_holdout</span><span class="p">,</span> <span class="n">y_train_full</span><span class="p">,</span> <span class="n">y_test_holdout</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_full</span><span class="p">,</span> <span class="n">y_full</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 6) CV manual 5-fold en el 80% (buscar k=1..20)</span>
<span class="c1">#    OHE + Escalado dentro del fold (sin fugas)</span>
<span class="c1"># --------------------------</span>
<span class="n">k_values</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">)</span>
<span class="n">cv_results</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;RMSE&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;MAE&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;R2&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;MedAE&quot;</span><span class="p">:</span> <span class="p">[]}</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">}</span>
<span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">tr_idx</span><span class="p">,</span> <span class="n">va_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_train_full</span><span class="p">):</span>
        <span class="n">X_tr_raw</span> <span class="o">=</span> <span class="n">X_train_full</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">tr_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">X_va_raw</span> <span class="o">=</span> <span class="n">X_train_full</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">va_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">y_tr</span> <span class="o">=</span> <span class="n">y_train_full</span><span class="p">[</span><span class="n">tr_idx</span><span class="p">]</span>
        <span class="n">y_va</span> <span class="o">=</span> <span class="n">y_train_full</span><span class="p">[</span><span class="n">va_idx</span><span class="p">]</span>

        <span class="c1"># OHE dentro del fold</span>
        <span class="n">X_tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_tr_raw</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X_va</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_va_raw</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">X_va</span> <span class="o">=</span> <span class="n">X_va</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">X_tr</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># Escalado dentro del fold (solo num√©ricas continuas existentes)</span>
        <span class="n">cols_to_scale</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">numeric_columns_pre_ohe</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_tr</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">X_tr</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_tr</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">])</span>
        <span class="n">X_va</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_va</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">])</span>

        <span class="c1"># Modelo y predicci√≥n</span>
        <span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
        <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
        <span class="n">y_pred</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_va</span><span class="p">)</span>

        <span class="c1"># M√©tricas del fold</span>
        <span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_va</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse</span><span class="p">))</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MAE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_va</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;R2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_va</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
        <span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MedAE&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_absolute_error</span><span class="p">(</span><span class="n">y_va</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>

<span class="c1"># Resumen por k</span>
<span class="n">summary</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">k_values</span><span class="p">:</span>
    <span class="n">summary</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
        <span class="s2">&quot;RMSE_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;RMSE_std&quot;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;RMSE&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;MAE_mean&quot;</span><span class="p">:</span>  <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MAE&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;R2_mean&quot;</span><span class="p">:</span>   <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;R2&quot;</span><span class="p">]),</span>
        <span class="s2">&quot;MedAE_mean&quot;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">cv_results</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="s2">&quot;MedAE&quot;</span><span class="p">]),</span>
    <span class="p">})</span>
<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;RMSE_mean&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===== Resumen CV 5-fold en TRAIN (ordenado por RMSE promedio) =====&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="n">best_k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">summary_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;k&quot;</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">‚úÖ Mejor k por RMSE promedio (CV en train): </span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># --------------------------</span>
<span class="c1"># 7) Entrenamiento FINAL en todo el 80% y evaluaci√≥n en HOLDOUT 20%</span>
<span class="c1"># --------------------------</span>
<span class="c1"># OHE en train_full y test_holdout usando columnas del train</span>
<span class="n">X_train_ohe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_train_full</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_test_ohe</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_test_holdout</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_test_ohe</span>  <span class="o">=</span> <span class="n">X_test_ohe</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">X_train_ohe</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Escalado final (ajustado SOLO con el train_full)</span>
<span class="n">cols_to_scale_final</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">numeric_columns_pre_ohe</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_train_ohe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">scaler_final</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train_scaled</span> <span class="o">=</span> <span class="n">X_train_ohe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_test_scaled</span>  <span class="o">=</span> <span class="n">X_test_ohe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_train_scaled</span><span class="p">[</span><span class="n">cols_to_scale_final</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler_final</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">[</span><span class="n">cols_to_scale_final</span><span class="p">])</span>
<span class="n">X_test_scaled</span><span class="p">[</span><span class="n">cols_to_scale_final</span><span class="p">]</span>  <span class="o">=</span> <span class="n">scaler_final</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">[</span><span class="n">cols_to_scale_final</span><span class="p">])</span>

<span class="c1"># Modelo final y m√©tricas en holdout</span>
<span class="n">knn_final</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">best_k</span><span class="p">)</span>
<span class="n">knn_final</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train_scaled</span><span class="p">,</span> <span class="n">y_train_full</span><span class="p">)</span>
<span class="n">y_pred_test</span> <span class="o">=</span> <span class="n">knn_final</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test_scaled</span><span class="p">)</span>

<span class="n">mse_test</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">,</span> <span class="n">y_pred_test</span><span class="p">)</span>
<span class="n">rmse_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mse_test</span><span class="p">)</span>
<span class="n">mae_test</span>  <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">,</span> <span class="n">y_pred_test</span><span class="p">)</span>
<span class="n">r2_test</span>   <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">,</span> <span class="n">y_pred_test</span><span class="p">)</span>
<span class="n">medae_test</span> <span class="o">=</span> <span class="n">median_absolute_error</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">,</span> <span class="n">y_pred_test</span><span class="p">)</span>

<span class="n">n_test</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y_test_holdout</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">X_test_scaled</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">r2_adj_test</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">r2_test</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">n_test</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">n_test</span> <span class="o">-</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">===== M√©tricas en HOLDOUT EXTERNO (20%) =====&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMSE:    </span><span class="si">{</span><span class="n">rmse_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAE:     </span><span class="si">{</span><span class="n">mae_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R¬≤:      </span><span class="si">{</span><span class="n">r2_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R¬≤_adj:  </span><span class="si">{</span><span class="n">r2_adj_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MedAE:   </span><span class="si">{</span><span class="n">medae_test</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===== Resumen CV 5-fold en TRAIN (ordenado por RMSE promedio) =====
 k  RMSE_mean  RMSE_std  MAE_mean  R2_mean  MedAE_mean
 8   1.699206  0.027630  1.054130 0.874195    0.670791
 9   1.700738  0.030459  1.056765 0.873982    0.659344
10   1.700751  0.029324  1.057884 0.874034    0.649848
11   1.701074  0.022036  1.059829 0.873964    0.636945
 7   1.705818  0.026141  1.056755 0.873234    0.689052
13   1.706670  0.018902  1.068118 0.873207    0.659298
12   1.707412  0.021673  1.062821 0.873013    0.645268
16   1.708865  0.013953  1.073470 0.872959    0.674978
14   1.710717  0.013977  1.071778 0.872646    0.661326
17   1.713130  0.011751  1.078210 0.872335    0.672045
15   1.714662  0.012336  1.076244 0.872073    0.677318
 6   1.716504  0.033356  1.059863 0.871575    0.679683
18   1.717232  0.007974  1.080895 0.871849    0.668324
19   1.719497  0.011367  1.082333 0.871519    0.661837
 5   1.727544  0.034021  1.066015 0.869929    0.680512
20   1.727761  0.018437  1.086901 0.870380    0.666470
 4   1.746472  0.022864  1.076429 0.867237    0.690893
 3   1.796817  0.027634  1.107182 0.859445    0.691120
 2   1.888046  0.031959  1.155614 0.845038    0.710839
 1   2.122718  0.093066  1.267973 0.803517    0.731613

‚úÖ Mejor k por RMSE promedio (CV en train): 8

===== M√©tricas en HOLDOUT EXTERNO (20%) =====
RMSE:    1.7889
MAE:     1.1016
R¬≤:      0.8610
R¬≤_adj:  0.8116
MedAE:   0.6909
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c1"># 1. Cargar el dataset</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="c1"># 2. Crear variable objetivo</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Final_Average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span>
    <span class="s2">&quot;Curricular units 1st sem (grade)&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Curricular units 2nd sem (grade)&quot;</span>
<span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># 3. Seleccionar columnas num√©ricas con m√°s de 10 valores √∫nicos</span>
<span class="n">numeric_columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># 4. Excluir variables no usadas en modelado</span>
<span class="n">excluir</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Final_Average&#39;</span><span class="p">,</span> <span class="s1">&#39;Target&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (grade)&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Curricular units 2nd sem (approved)&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Curricular units 2nd sem (evaluations)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (credited)&quot;</span><span class="p">,</span> 
    <span class="s2">&quot;Curricular units 2nd sem (enrolled)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (without evaluations)&quot;</span>
<span class="p">]</span>
<span class="n">numeric_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluir</span> <span class="ow">and</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">]</span>

<span class="c1"># 5. Funci√≥n para graficar boxplots y devolver l√≠mites IQR</span>
<span class="k">def</span><span class="w"> </span><span class="nf">graficar_y_detectar_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">columnas</span><span class="p">,</span> <span class="n">grupo</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">limites</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">columnas</span><span class="p">),</span> <span class="n">grupo</span><span class="p">):</span>
        <span class="n">subset</span> <span class="o">=</span> <span class="n">columnas</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">grupo</span><span class="p">]</span>
        
        <span class="c1"># Calcular l√≠mites por columna</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">subset</span><span class="p">:</span>
            <span class="n">Q1</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
            <span class="n">Q3</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
            <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
            <span class="n">lower</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>
            <span class="n">upper</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>
            <span class="n">limites</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>
        
        <span class="c1"># Graficar</span>
        <span class="n">df_melt</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">subset</span><span class="p">]</span><span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">var_name</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;Valor&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df_melt</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;Variable&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;Valor&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Boxplot variables num√©ricas (</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> a </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">subset</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">limites</span>

<span class="c1"># 6. Detectar y mostrar l√≠mites</span>
<span class="n">limites_outliers</span> <span class="o">=</span> <span class="n">graficar_y_detectar_outliers</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">numeric_columns</span><span class="p">)</span>

<span class="c1"># 7. Mostrar resumen de columnas con posibles outliers</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">üìä Posibles outliers detectados (valores fuera de [lim_inf, lim_sup]):&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">)</span> <span class="ow">in</span> <span class="n">limites_outliers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">n_outliers</span> <span class="o">=</span> <span class="p">((</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">low</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">high</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">n_outliers</span><span class="si">}</span><span class="s2"> outliers (lim_inf=</span><span class="si">{</span><span class="n">low</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">, lim_sup=</span><span class="si">{</span><span class="n">high</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>

<span class="c1"># 8. Winsorizaci√≥n opcional (descomenta si quieres aplicar)</span>
<span class="c1"># for col, (low, high) in limites_outliers.items():</span>
<span class="c1">#     df[col] = np.where(df[col] &lt; low, low, df[col])</span>
<span class="c1">#     df[col] = np.where(df[col] &gt; high, high, df[col])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
</pre></div>
</div>
<img alt="_images/c04128c6d3b9a96a7de7ded5da42d5eb7067fd67183326c2881647e37673239a.png" src="_images/c04128c6d3b9a96a7de7ded5da42d5eb7067fd67183326c2881647e37673239a.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
</pre></div>
</div>
<img alt="_images/8d5379f8ff87254d505b700b55c1eeb79aebd6fb41e6a56134d1f5d1584a359a.png" src="_images/8d5379f8ff87254d505b700b55c1eeb79aebd6fb41e6a56134d1f5d1584a359a.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
</pre></div>
</div>
<img alt="_images/eb6096ebbedaf2467be290455e1aaf8526d9670cd1c5509de62de64b92d4094c.png" src="_images/eb6096ebbedaf2467be290455e1aaf8526d9670cd1c5509de62de64b92d4094c.png" />
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>üìä Posibles outliers detectados (valores fuera de [lim_inf, lim_sup]):
Application mode: 0 outliers (lim_inf=-56.00, lim_sup=96.00)
Course: 442 outliers (lim_inf=8378.50, lim_sup=10262.50)
Previous qualification: 707 outliers (lim_inf=1.00, lim_sup=1.00)
Previous qualification (grade): 179 outliers (lim_inf=102.50, lim_sup=162.50)
Nacionality: 110 outliers (lim_inf=1.00, lim_sup=1.00)
Mother&#39;s qualification: 0 outliers (lim_inf=-50.50, lim_sup=89.50)
Father&#39;s qualification: 0 outliers (lim_inf=-48.00, lim_sup=88.00)
Mother&#39;s occupation: 182 outliers (lim_inf=-3.50, lim_sup=16.50)
Father&#39;s occupation: 177 outliers (lim_inf=-3.50, lim_sup=16.50)
Admission grade: 86 outliers (lim_inf=92.55, lim_sup=160.15)
Age at enrollment: 441 outliers (lim_inf=10.00, lim_sup=34.00)
Curricular units 1st sem (credited): 577 outliers (lim_inf=0.00, lim_sup=0.00)
Curricular units 1st sem (enrolled): 424 outliers (lim_inf=2.00, lim_sup=10.00)
Curricular units 1st sem (evaluations): 158 outliers (lim_inf=0.00, lim_sup=16.00)
Curricular units 1st sem (approved): 180 outliers (lim_inf=-1.50, lim_sup=10.50)
Curricular units 1st sem (grade): 726 outliers (lim_inf=7.40, lim_sup=17.00)
Curricular units 1st sem (without evaluations): 294 outliers (lim_inf=0.00, lim_sup=0.00)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># ==============================================</span>
<span class="c1"># Comparaci√≥n KNN Regresi√≥n: Original vs Winsorizado vs Sin Outliers</span>
<span class="c1"># - Sin data leakage (OHE + escalado dentro del fold)</span>
<span class="c1"># - CV manual 5-fold</span>
<span class="c1"># - k = 1..20</span>
<span class="c1"># ==============================================</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">KFold</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">median_absolute_error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats.mstats</span><span class="w"> </span><span class="kn">import</span> <span class="n">winsorize</span>

<span class="c1"># -----------------------</span>
<span class="c1"># 1) Cargar dataset</span>
<span class="c1"># -----------------------</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data.csv&quot;</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;;&quot;</span><span class="p">)</span>

<span class="c1"># -----------------------</span>
<span class="c1"># 2) Crear variable objetivo (promedio 1¬∫ y 2¬∫ semestre)</span>
<span class="c1"># -----------------------</span>
<span class="n">df</span><span class="p">[</span><span class="s2">&quot;Final_Average&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[[</span>
    <span class="s2">&quot;Curricular units 1st sem (grade)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (grade)&quot;</span>
<span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># -----------------------</span>
<span class="c1"># 3) Evitar fuga: eliminar TODAS las del 2¬∫ semestre + Target + la propia y</span>
<span class="c1"># -----------------------</span>
<span class="n">cols_to_exclude</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Target&quot;</span><span class="p">,</span> <span class="s2">&quot;Final_Average&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (grade)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (approved)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (evaluations)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (credited)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (enrolled)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (without evaluations)&quot;</span>
<span class="p">]</span>
<span class="n">X_base</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_to_exclude</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
<span class="n">y_base</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Final_Average&quot;</span><span class="p">]</span>  <span class="c1"># Series</span>

<span class="c1"># -----------------------</span>
<span class="c1"># 4) Lista fija de categ√≥ricas (filtrada a las que existan)</span>
<span class="c1"># -----------------------</span>
<span class="n">categorical_columns_all</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Marital status&#39;</span><span class="p">,</span> <span class="s1">&#39;Application mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Application order&#39;</span><span class="p">,</span> <span class="s1">&#39;Course&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Daytime/evening attendance&#39;</span><span class="p">,</span> <span class="s1">&#39;Previous qualification&#39;</span><span class="p">,</span> <span class="s1">&#39;Nacionality&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Mother&#39;s qualification&quot;</span><span class="p">,</span> <span class="s2">&quot;Father&#39;s qualification&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mother&#39;s occupation&quot;</span><span class="p">,</span> <span class="s2">&quot;Father&#39;s occupation&quot;</span><span class="p">,</span> <span class="s1">&#39;Displaced&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Educational special needs&#39;</span><span class="p">,</span> <span class="s1">&#39;Debtor&#39;</span><span class="p">,</span> <span class="s1">&#39;Tuition fees up to date&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="s1">&#39;Scholarship holder&#39;</span><span class="p">,</span> <span class="s1">&#39;International&#39;</span>
<span class="p">]</span>
<span class="n">categorical_columns_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categorical_columns_all</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_base</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="c1"># -----------------------</span>
<span class="c1"># 5) Funciones de tratamiento de outliers SOLO en num√©ricas reales</span>
<span class="c1"># -----------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_numeric_real_cols</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">cat_cols</span><span class="p">):</span>
    <span class="c1"># num√©ricas reales = columnas no listadas como categ√≥ricas (y con dtype num√©rico)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span><span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cat_cols</span><span class="p">]</span>

<span class="k">def</span><span class="w"> </span><span class="nf">winsorize_df</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)):</span>
    <span class="n">Xw</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">num_cols</span><span class="p">:</span>
        <span class="c1"># winsorize devuelve masked array; convertir a np.array</span>
        <span class="n">Xw</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">winsorize</span><span class="p">(</span><span class="n">Xw</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">limits</span><span class="o">=</span><span class="n">limits</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">Xw</span>

<span class="k">def</span><span class="w"> </span><span class="nf">remove_outliers_df</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">num_cols</span><span class="p">):</span>
    <span class="n">Xr</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="c1"># Construir una m√°scara global manteniendo filas dentro de IQR en TODAS las num√©ricas</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">Xr</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">num_cols</span><span class="p">:</span>
        <span class="n">Q1</span> <span class="o">=</span> <span class="n">Xr</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.25</span><span class="p">)</span>
        <span class="n">Q3</span> <span class="o">=</span> <span class="n">Xr</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mf">0.75</span><span class="p">)</span>
        <span class="n">IQR</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">-</span> <span class="n">Q1</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">Q1</span> <span class="o">-</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">Q3</span> <span class="o">+</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">IQR</span>
        <span class="n">mask</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">Xr</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lower</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Xr</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">Xr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

<span class="c1"># -----------------------</span>
<span class="c1"># 6) Evaluaci√≥n con CV 5-fold, OHE y escalado DENTRO del fold</span>
<span class="c1"># -----------------------</span>
<span class="k">def</span><span class="w"> </span><span class="nf">evaluar_dataset</span><span class="p">(</span><span class="n">X_in</span><span class="p">,</span> <span class="n">y_in</span><span class="p">,</span> <span class="n">cat_cols</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    - X_in: features del dataset (posiblemente tratado)</span>
<span class="sd">    - y_in: Series con el objetivo</span>
<span class="sd">    - cat_cols: lista de categ√≥ricas a considerar (intersectaremos seg√∫n existan en X_in)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Asegurar alineaci√≥n (por si X_in fue filtrado por outliers)</span>
    <span class="n">y_in</span> <span class="o">=</span> <span class="n">y_in</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">X_in</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>

    <span class="c1"># Determinar columnas por TIPO para ESTE dataset</span>
    <span class="n">cat_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cat_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_in</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
    <span class="n">num_cols</span> <span class="o">=</span> <span class="n">get_numeric_real_cols</span><span class="p">(</span><span class="n">X_in</span><span class="p">,</span> <span class="n">cat_cols</span><span class="p">)</span>

    <span class="n">kf</span> <span class="o">=</span> <span class="n">KFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>
    <span class="n">resultados</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">21</span><span class="p">):</span>
        <span class="n">rmse_list</span><span class="p">,</span> <span class="n">mae_list</span><span class="p">,</span> <span class="n">r2_list</span><span class="p">,</span> <span class="n">medae_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">tr_idx</span><span class="p">,</span> <span class="n">va_idx</span> <span class="ow">in</span> <span class="n">kf</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">X_in</span><span class="p">):</span>
            <span class="n">X_tr_raw</span> <span class="o">=</span> <span class="n">X_in</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">tr_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">X_va_raw</span> <span class="o">=</span> <span class="n">X_in</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">va_idx</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">y_tr</span> <span class="o">=</span> <span class="n">y_in</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">tr_idx</span><span class="p">]</span>
            <span class="n">y_va</span> <span class="o">=</span> <span class="n">y_in</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">va_idx</span><span class="p">]</span>

            <span class="c1"># OHE dentro del fold (solo columnas categ√≥ricas que existan en este fold)</span>
            <span class="n">cats_fold</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cat_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_tr_raw</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">X_tr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_tr_raw</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cats_fold</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">X_va</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_va_raw</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cats_fold</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># Alinear columnas (categor√≠as faltantes a 0)</span>
            <span class="n">X_va</span> <span class="o">=</span> <span class="n">X_va</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">X_tr</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

            <span class="c1"># Escalado SOLO en num√©ricas reales presentes tras OHE</span>
            <span class="n">cols_to_scale</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">num_cols</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_tr</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="n">X_tr</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_tr</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">])</span>
            <span class="n">X_va</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_va</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">])</span>

            <span class="c1"># Modelo y predicci√≥n</span>
            <span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="n">k</span><span class="p">)</span>
            <span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_tr</span><span class="p">,</span> <span class="n">y_tr</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_va</span><span class="p">)</span>

            <span class="c1"># M√©tricas</span>
            <span class="n">rmse_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_va</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)))</span>
            <span class="n">mae_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_va</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
            <span class="n">r2_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_va</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
            <span class="n">medae_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">median_absolute_error</span><span class="p">(</span><span class="n">y_va</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>

        <span class="n">resultados</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s2">&quot;k&quot;</span><span class="p">:</span> <span class="n">k</span><span class="p">,</span>
            <span class="s2">&quot;RMSE_mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">rmse_list</span><span class="p">)),</span>
            <span class="s2">&quot;MAE_mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mae_list</span><span class="p">)),</span>
            <span class="s2">&quot;R2_mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">r2_list</span><span class="p">)),</span>
            <span class="s2">&quot;MedAE_mean&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">medae_list</span><span class="p">))</span>
        <span class="p">})</span>

    <span class="n">df_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">resultados</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;RMSE_mean&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">best_row</span> <span class="o">=</span> <span class="n">df_res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">df_res</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">best_row</span><span class="p">[</span><span class="s2">&quot;k&quot;</span><span class="p">])</span>

<span class="c1"># -----------------------</span>
<span class="c1"># 7) Preparar datasets (Original / Winsorizado / Sin Outliers)</span>
<span class="c1"># -----------------------</span>
<span class="c1"># columnas num√©ricas reales del X_base para tratamientos</span>
<span class="n">num_cols_base</span> <span class="o">=</span> <span class="n">get_numeric_real_cols</span><span class="p">(</span><span class="n">X_base</span><span class="p">,</span> <span class="n">categorical_columns_all</span><span class="p">)</span>

<span class="n">datasets</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;Original&quot;</span><span class="p">:</span> <span class="n">X_base</span><span class="p">,</span>
    <span class="s2">&quot;Winsorizado&quot;</span><span class="p">:</span> <span class="n">winsorize_df</span><span class="p">(</span><span class="n">X_base</span><span class="p">,</span> <span class="n">num_cols_base</span><span class="p">,</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)),</span>  <span class="c1"># 5%-5% por defecto</span>
    <span class="s2">&quot;Sin Outliers&quot;</span><span class="p">:</span> <span class="n">remove_outliers_df</span><span class="p">(</span><span class="n">X_base</span><span class="p">,</span> <span class="n">num_cols_base</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># -----------------------</span>
<span class="c1"># 8) Evaluar y comparar</span>
<span class="c1"># -----------------------</span>
<span class="n">comparacion_final</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">detalles_por_ds</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">nombre</span><span class="p">,</span> <span class="n">Xv</span> <span class="ow">in</span> <span class="n">datasets</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">=== Evaluando dataset: </span><span class="si">{</span><span class="n">nombre</span><span class="si">}</span><span class="s2"> ===&quot;</span><span class="p">)</span>
    <span class="c1"># Recalcular y para el caso &quot;Sin Outliers&quot; (por si filtr√≥ filas)</span>
    <span class="n">yv</span> <span class="o">=</span> <span class="n">y_base</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">Xv</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
    <span class="c1"># Filtrar categ√≥ricas disponibles en ESTA versi√≥n de X</span>
    <span class="n">cat_v</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categorical_columns_all</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">Xv</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

    <span class="n">df_res</span><span class="p">,</span> <span class="n">best_k</span> <span class="o">=</span> <span class="n">evaluar_dataset</span><span class="p">(</span><span class="n">Xv</span><span class="p">,</span> <span class="n">yv</span><span class="p">,</span> <span class="n">cat_v</span><span class="p">)</span>
    <span class="n">detalles_por_ds</span><span class="p">[</span><span class="n">nombre</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_res</span>  <span class="c1"># por si quieres ver la curva RMSE vs k luego</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">df_res</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>  <span class="c1"># top-3 para revisar</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mejor k: </span><span class="si">{</span><span class="n">best_k</span><span class="si">}</span><span class="s2"> | RMSE: </span><span class="si">{</span><span class="n">df_res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;RMSE_mean&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">comparacion_final</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
        <span class="s2">&quot;Dataset&quot;</span><span class="p">:</span> <span class="n">nombre</span><span class="p">,</span>
        <span class="s2">&quot;Mejor_k&quot;</span><span class="p">:</span> <span class="n">best_k</span><span class="p">,</span>
        <span class="s2">&quot;RMSE&quot;</span><span class="p">:</span> <span class="n">df_res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;RMSE_mean&quot;</span><span class="p">],</span>
        <span class="s2">&quot;MAE&quot;</span><span class="p">:</span> <span class="n">df_res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;MAE_mean&quot;</span><span class="p">],</span>
        <span class="s2">&quot;R2&quot;</span><span class="p">:</span> <span class="n">df_res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;R2_mean&quot;</span><span class="p">],</span>
        <span class="s2">&quot;MedAE&quot;</span><span class="p">:</span> <span class="n">df_res</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;MedAE_mean&quot;</span><span class="p">]</span>
    <span class="p">})</span>

<span class="n">df_comparacion</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">comparacion_final</span><span class="p">)</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s2">&quot;RMSE&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">üìä Comparaci√≥n final entre datasets (ordenado por RMSE):&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">df_comparacion</span><span class="o">.</span><span class="n">to_string</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>=== Evaluando dataset: Original ===
 k  RMSE_mean  MAE_mean  R2_mean  MedAE_mean
 9   1.679730  1.039846 0.876763    0.654618
10   1.683860  1.044105 0.876197    0.653193
 8   1.685886  1.042982 0.875783    0.665716
Mejor k: 9 | RMSE: 1.6797

=== Evaluando dataset: Winsorizado ===
 k  RMSE_mean  MAE_mean  R2_mean  MedAE_mean
11   1.636199  1.019540 0.883280    0.643260
10   1.638638  1.017635 0.882868    0.639433
12   1.642213  1.024382 0.882417    0.644198
Mejor k: 11 | RMSE: 1.6362

=== Evaluando dataset: Sin Outliers ===
 k  RMSE_mean  MAE_mean  R2_mean  MedAE_mean
15   1.331213  0.761295 0.477004    0.470343
14   1.331234  0.762547 0.477045    0.469394
20   1.331344  0.756286 0.477172    0.464308
Mejor k: 15 | RMSE: 1.3312

üìä Comparaci√≥n final entre datasets (ordenado por RMSE):
     Dataset  Mejor_k     RMSE      MAE       R2    MedAE
Sin Outliers       15 1.331213 0.761295 0.477004 0.470343
 Winsorizado       11 1.636199 1.019540 0.883280 0.643260
    Original        9 1.679730 1.039846 0.876763 0.654618
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy.stats.mstats</span><span class="w"> </span><span class="kn">import</span> <span class="n">winsorize</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">median_absolute_error</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="c1"># --- 1) Partimos de df ya cargado y Final_Average creado ---</span>
<span class="c1"># Si no lo tienes, descomenta estas dos l√≠neas:</span>
<span class="c1"># df = pd.read_csv(&quot;data.csv&quot;, sep=&quot;;&quot;)</span>
<span class="c1"># df[&quot;Final_Average&quot;] = df[[&quot;Curricular units 1st sem (grade)&quot;, &quot;Curricular units 2nd sem (grade)&quot;]].mean(axis=1)</span>

<span class="c1"># --- 2) Quitar columnas que causan fuga (todas las del 2¬∫ semestre + Target + la propia y) ---</span>
<span class="n">cols_to_exclude</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Target&quot;</span><span class="p">,</span> <span class="s2">&quot;Final_Average&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (grade)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (approved)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (evaluations)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (credited)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (enrolled)&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Curricular units 2nd sem (without evaluations)&quot;</span>
<span class="p">]</span>
<span class="n">X_base</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">cols_to_exclude</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Final_Average&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

<span class="c1"># --- 3) Lista fija de categ√≥ricas (filtrada a las que existan) ---</span>
<span class="n">categorical_columns_all</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;Marital status&#39;</span><span class="p">,</span> <span class="s1">&#39;Application mode&#39;</span><span class="p">,</span> <span class="s1">&#39;Application order&#39;</span><span class="p">,</span> <span class="s1">&#39;Course&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Daytime/evening attendance&#39;</span><span class="p">,</span> <span class="s1">&#39;Previous qualification&#39;</span><span class="p">,</span> <span class="s1">&#39;Nacionality&#39;</span><span class="p">,</span>
    <span class="s2">&quot;Mother&#39;s qualification&quot;</span><span class="p">,</span> <span class="s2">&quot;Father&#39;s qualification&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mother&#39;s occupation&quot;</span><span class="p">,</span> <span class="s2">&quot;Father&#39;s occupation&quot;</span><span class="p">,</span> <span class="s1">&#39;Displaced&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Educational special needs&#39;</span><span class="p">,</span> <span class="s1">&#39;Debtor&#39;</span><span class="p">,</span> <span class="s1">&#39;Tuition fees up to date&#39;</span><span class="p">,</span>
    <span class="s1">&#39;Gender&#39;</span><span class="p">,</span> <span class="s1">&#39;Scholarship holder&#39;</span><span class="p">,</span> <span class="s1">&#39;International&#39;</span>
<span class="p">]</span>
<span class="n">categorical_columns_all</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categorical_columns_all</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_base</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>

<span class="c1"># Num√©ricas reales (para winsorizar y luego escalar)</span>
<span class="n">num_cols_base</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_base</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span><span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">categorical_columns_all</span><span class="p">]</span>

<span class="c1"># --- 4) Construir X_winsor (5%‚Äì5% por defecto) ---</span>
<span class="n">X_winsor</span> <span class="o">=</span> <span class="n">X_base</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">num_cols_base</span><span class="p">:</span>
    <span class="n">X_winsor</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">winsorize</span><span class="p">(</span><span class="n">X_winsor</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">limits</span><span class="o">=</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)))</span>

<span class="c1"># --- 5) Split holdout externo 20% (sin fugas) ---</span>
<span class="n">X_train_raw</span><span class="p">,</span> <span class="n">X_test_raw</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_winsor</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.20</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># --- 6) OHE SOLO con TRAIN y alinear TEST ---</span>
<span class="n">cats_train</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">categorical_columns_all</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_train_raw</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">X_train_ohe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_train_raw</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">cats_train</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_test_ohe</span>  <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_test_raw</span><span class="p">,</span>  <span class="n">columns</span><span class="o">=</span><span class="n">cats_train</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_test_ohe</span>  <span class="o">=</span> <span class="n">X_test_ohe</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">X_train_ohe</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># --- 7) Escalado SOLO en num√©ricas reales presentes (no escalar dummies) ---</span>
<span class="n">cols_to_scale</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">num_cols_base</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">X_train_ohe</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">X_train</span> <span class="o">=</span> <span class="n">X_train_ohe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_test</span>  <span class="o">=</span> <span class="n">X_test_ohe</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">X_train</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">])</span>
<span class="n">X_test</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">]</span>  <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">cols_to_scale</span><span class="p">])</span>

<span class="c1"># --- 8) Entrenar KNN final con k=11 (mejor en winsorizado) y evaluar ---</span>
<span class="n">knn</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">knn</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">knn</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="n">rmse</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)))</span>
<span class="n">mae</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="n">r2</span>   <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="n">medae</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">median_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;===== M√©tricas en HOLDOUT EXTERNO (Winsorizado, k=11) =====&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMSE:   </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAE:    </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R¬≤:     </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MedAE:  </span><span class="si">{</span><span class="n">medae</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># --- 9) Gr√°ficos (sin fugas, en test externo) ---</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">y_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="n">y_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="s1">&#39;r--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Valor real&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Valor predicho&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;üìà Real vs Predicho ‚Äî Winsorizado (k=11)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="n">residuals</span> <span class="o">=</span> <span class="n">y_test</span> <span class="o">-</span> <span class="n">y_pred</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;üìâ Distribuci√≥n de errores (residuos) ‚Äî Holdout&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Error (real - predicho)&quot;</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frecuencia&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">);</span> <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">();</span> <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>===== M√©tricas en HOLDOUT EXTERNO (Winsorizado, k=11) =====
RMSE:   1.6802
MAE:    1.0537
R¬≤:     0.8774
MedAE:  0.6534
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\migue\AppData\Local\Temp\ipykernel_20736\2054813078.py:88: UserWarning: Glyph 128200 (\N{CHART WITH UPWARDS TREND}) missing from current font.
  plt.grid(True); plt.tight_layout(); plt.show()
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\pylabtools.py:152: UserWarning: Glyph 128200 (\N{CHART WITH UPWARDS TREND}) missing from current font.
  fig.canvas.print_figure(bytes_io, **kw)
</pre></div>
</div>
<img alt="_images/34e0f21f3d6e8eb76819e22af5394e9f16983ec5e7496c4a85268ba9ef98b606.png" src="_images/34e0f21f3d6e8eb76819e22af5394e9f16983ec5e7496c4a85268ba9ef98b606.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\migue\AppData\Local\Temp\ipykernel_20736\2054813078.py:96: UserWarning: Glyph 128201 (\N{CHART WITH DOWNWARDS TREND}) missing from current font.
  plt.grid(True); plt.tight_layout(); plt.show()
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\pylabtools.py:152: UserWarning: Glyph 128201 (\N{CHART WITH DOWNWARDS TREND}) missing from current font.
  fig.canvas.print_figure(bytes_io, **kw)
</pre></div>
</div>
<img alt="_images/56e8da9eadf60152540e504c87c955babd6288252cc81f51ba02b903e9aeec3f.png" src="_images/56e8da9eadf60152540e504c87c955babd6288252cc81f51ba02b903e9aeec3f.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<span class="o">!</span>pip<span class="w"> </span>install<span class="w"> </span>statsmodels
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">seaborn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sns</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">statsmodels.api</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.model_selection</span><span class="w"> </span><span class="kn">import</span> <span class="n">train_test_split</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.preprocessing</span><span class="w"> </span><span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.neighbors</span><span class="w"> </span><span class="kn">import</span> <span class="n">KNeighborsRegressor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sklearn.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">mean_absolute_error</span><span class="p">,</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">median_absolute_error</span>
<span class="p">)</span>

<span class="c1"># 1. Divisi√≥n train/test</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span>
    <span class="n">X_winsor</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span>
<span class="p">)</span>

<span class="c1"># 2. One-hot encoding y escalado SOLO en TRAIN</span>
<span class="n">categorical_columns</span> <span class="o">=</span> <span class="n">base_categoricals</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;Course&#39;</span><span class="p">,</span> <span class="s1">&#39;Nacionality&#39;</span><span class="p">]</span>
<span class="n">numeric_columns</span> <span class="o">=</span> <span class="n">X_winsor</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">include</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;float64&#39;</span><span class="p">,</span> <span class="s1">&#39;int64&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">X_train</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">categorical_columns</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Alinear columnas</span>
<span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span> <span class="o">=</span> <span class="n">X_train</span><span class="o">.</span><span class="n">align</span><span class="p">(</span><span class="n">X_test</span><span class="p">,</span> <span class="n">join</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Escalado</span>
<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">columns_to_scale</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">numeric_columns</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X_train</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">X_train</span><span class="p">[</span><span class="n">columns_to_scale</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X_train</span><span class="p">[</span><span class="n">columns_to_scale</span><span class="p">])</span>
<span class="n">X_test</span><span class="p">[</span><span class="n">columns_to_scale</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X_test</span><span class="p">[</span><span class="n">columns_to_scale</span><span class="p">])</span>

<span class="c1"># 3. Entrenar modelo final (k=11)</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">KNeighborsRegressor</span><span class="p">(</span><span class="n">n_neighbors</span><span class="o">=</span><span class="mi">11</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># 4. Calcular m√©tricas</span>
<span class="n">rmse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
<span class="n">mae</span> <span class="o">=</span> <span class="n">mean_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">medae</span> <span class="o">=</span> <span class="n">median_absolute_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;===== M√©tricas en HOLDOUT EXTERNO (Winsorizado, k=11) =====&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;RMSE:   </span><span class="si">{</span><span class="n">rmse</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MAE:    </span><span class="si">{</span><span class="n">mae</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;R¬≤:     </span><span class="si">{</span><span class="n">r2</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MedAE:  </span><span class="si">{</span><span class="n">medae</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="c1"># =======================</span>
<span class="c1"># 5. Visualizaciones</span>
<span class="c1"># =======================</span>

<span class="c1"># 5.1 Real vs Predicho con l√≠nea de regresi√≥n</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">regplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">scatter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">y_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="p">[</span><span class="n">y_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">y_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> <span class="s1">&#39;g--&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Valor real&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Valor predicho&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;üìà Real vs Predicho ‚Äî Winsorizado (k=11)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 5.2 Distribuci√≥n de residuos</span>
<span class="n">residuals</span> <span class="o">=</span> <span class="n">y_test</span> <span class="o">-</span> <span class="n">y_pred</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">kde</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;steelblue&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;üìâ Distribuci√≥n de errores (residuos) ‚Äî Holdout&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Error (real - predicho)&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Frecuencia&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 5.3 QQ-plot para normalidad de residuos</span>
<span class="n">sm</span><span class="o">.</span><span class="n">qqplot</span><span class="p">(</span><span class="n">residuals</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;45&#39;</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;QQ-plot de residuos ‚Äî Holdout&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># 5.4 Residuos vs Valores predichos</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">residuals</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.6</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Residuos vs Valores predichos ‚Äî Holdout&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Valores predichos&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Residuos&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  WARNING: Failed to remove contents in a temporary directory &#39;C:\Users\migue\miniconda3\envs\ml_venv\Lib\site-packages\~andas.libs&#39;.
  You can safely remove it manually.
  WARNING: Failed to remove contents in a temporary directory &#39;C:\Users\migue\miniconda3\envs\ml_venv\Lib\site-packages\~andas&#39;.
  You can safely remove it manually.

[notice] A new release of pip is available: 25.1.1 -&gt; 25.2
[notice] To update, run: python.exe -m pip install --upgrade pip
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Collecting statsmodels
  Downloading statsmodels-0.14.5-cp39-cp39-win_amd64.whl.metadata (9.8 kB)
Requirement already satisfied: numpy&lt;3,&gt;=1.22.3 in c:\users\migue\miniconda3\envs\ml_venv\lib\site-packages (from statsmodels) (1.25.2)
Requirement already satisfied: scipy!=1.9.2,&gt;=1.8 in c:\users\migue\miniconda3\envs\ml_venv\lib\site-packages (from statsmodels) (1.11.2)
Collecting pandas!=2.1.0,&gt;=1.4 (from statsmodels)
  Downloading pandas-2.3.1-cp39-cp39-win_amd64.whl.metadata (19 kB)
Collecting patsy&gt;=0.5.6 (from statsmodels)
  Downloading patsy-1.0.1-py2.py3-none-any.whl.metadata (3.3 kB)
Requirement already satisfied: packaging&gt;=21.3 in c:\users\migue\miniconda3\envs\ml_venv\lib\site-packages (from statsmodels) (23.1)
Requirement already satisfied: python-dateutil&gt;=2.8.2 in c:\users\migue\miniconda3\envs\ml_venv\lib\site-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels) (2.8.2)
Requirement already satisfied: pytz&gt;=2020.1 in c:\users\migue\miniconda3\envs\ml_venv\lib\site-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels) (2023.3)
Requirement already satisfied: tzdata&gt;=2022.7 in c:\users\migue\miniconda3\envs\ml_venv\lib\site-packages (from pandas!=2.1.0,&gt;=1.4-&gt;statsmodels) (2023.3)
Requirement already satisfied: six&gt;=1.5 in c:\users\migue\miniconda3\envs\ml_venv\lib\site-packages (from python-dateutil&gt;=2.8.2-&gt;pandas!=2.1.0,&gt;=1.4-&gt;statsmodels) (1.16.0)
Downloading statsmodels-0.14.5-cp39-cp39-win_amd64.whl (9.7 MB)
   ---------------------------------------- 0.0/9.7 MB ? eta -:--:--
   ----- ---------------------------------- 1.3/9.7 MB 13.4 MB/s eta 0:00:01
   -------------------------- ------------- 6.3/9.7 MB 20.3 MB/s eta 0:00:01
   ---------------------------------------- 9.7/9.7 MB 22.3 MB/s eta 0:00:00
Downloading pandas-2.3.1-cp39-cp39-win_amd64.whl (11.4 MB)
   ---------------------------------------- 0.0/11.4 MB ? eta -:--:--
   -------------------- ------------------- 5.8/11.4 MB 29.4 MB/s eta 0:00:01
   -------------------------------------- - 11.0/11.4 MB 27.6 MB/s eta 0:00:01
   ---------------------------------------- 11.4/11.4 MB 27.3 MB/s eta 0:00:00
Downloading patsy-1.0.1-py2.py3-none-any.whl (232 kB)
Installing collected packages: patsy, pandas, statsmodels

   ---------------------------------------- 0/3 [patsy]
  Attempting uninstall: pandas
   ---------------------------------------- 0/3 [patsy]
    Found existing installation: pandas 2.1.0
   ---------------------------------------- 0/3 [patsy]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
    Uninstalling pandas-2.1.0:
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
      Successfully uninstalled pandas-2.1.0
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   ------------- -------------------------- 1/3 [pandas]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   -------------------------- ------------- 2/3 [statsmodels]
   ---------------------------------------- 3/3 [statsmodels]

Successfully installed pandas-2.3.1 patsy-1.0.1 statsmodels-0.14.5
===== M√©tricas en HOLDOUT EXTERNO (Winsorizado, k=11) =====
RMSE:   1.7320
MAE:    1.1010
R¬≤:     0.8697
MedAE:  0.6977
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
C:\Users\migue\AppData\Local\Temp\ipykernel_20736\1529436941.py:65: UserWarning: Glyph 128200 (\N{CHART WITH UPWARDS TREND}) missing from current font.
  plt.tight_layout()
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\pylabtools.py:152: UserWarning: Glyph 128200 (\N{CHART WITH UPWARDS TREND}) missing from current font.
  fig.canvas.print_figure(bytes_io, **kw)
</pre></div>
</div>
<img alt="_images/47d8634d41ddcecb8cdaafb904eb6441595c6996a08a298fedfdce0136da3717.png" src="_images/47d8634d41ddcecb8cdaafb904eb6441595c6996a08a298fedfdce0136da3717.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1119: FutureWarning: use_inf_as_na option is deprecated and will be removed in a future version. Convert inf values to NaN before operating instead.
  with pd.option_context(&#39;mode.use_inf_as_na&#39;, True):
C:\Users\migue\AppData\Local\Temp\ipykernel_20736\1529436941.py:77: UserWarning: Glyph 128201 (\N{CHART WITH DOWNWARDS TREND}) missing from current font.
  plt.tight_layout()
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\pylabtools.py:152: UserWarning: Glyph 128201 (\N{CHART WITH DOWNWARDS TREND}) missing from current font.
  fig.canvas.print_figure(bytes_io, **kw)
</pre></div>
</div>
<img alt="_images/6f697d9df5d58c623de7a7521f803dc509a40d9723d17efe12020731872d3d03.png" src="_images/6f697d9df5d58c623de7a7521f803dc509a40d9723d17efe12020731872d3d03.png" />
<img alt="_images/51930077afb57ea6fdd95df828b75a88c5c620861c4913eafd4e7914b149c47e.png" src="_images/51930077afb57ea6fdd95df828b75a88c5c620861c4913eafd4e7914b149c47e.png" />
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\seaborn\_oldcore.py:1498: FutureWarning: is_categorical_dtype is deprecated and will be removed in a future version. Use isinstance(dtype, CategoricalDtype) instead
  if pd.api.types.is_categorical_dtype(vector):
</pre></div>
</div>
<img alt="_images/b6cf713eda89ab1b52a70dbe188e011b96cd7766ad2ac6c094b4af05c91d7100.png" src="_images/b6cf713eda89ab1b52a70dbe188e011b96cd7766ad2ac6c094b4af05c91d7100.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>

<span class="c1"># üìå Resultados de la validaci√≥n cruzada (Winsorizado, k=11)</span>
<span class="n">cv_results</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;RMSE&quot;</span><span class="p">:</span> <span class="mf">1.6362</span><span class="p">,</span>  <span class="c1"># Valor promedio de la CV</span>
    <span class="s2">&quot;MAE&quot;</span><span class="p">:</span> <span class="mf">1.0195</span><span class="p">,</span>
    <span class="s2">&quot;R¬≤&quot;</span><span class="p">:</span> <span class="mf">0.8833</span><span class="p">,</span>
    <span class="s2">&quot;MedAE&quot;</span><span class="p">:</span> <span class="mf">0.6433</span>
<span class="p">}</span>

<span class="c1"># üìå Resultados del Holdout externo</span>
<span class="n">holdout_results</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;RMSE&quot;</span><span class="p">:</span> <span class="mf">1.7320</span><span class="p">,</span>
    <span class="s2">&quot;MAE&quot;</span><span class="p">:</span> <span class="mf">1.1010</span><span class="p">,</span>
    <span class="s2">&quot;R¬≤&quot;</span><span class="p">:</span> <span class="mf">0.8697</span><span class="p">,</span>
    <span class="s2">&quot;MedAE&quot;</span><span class="p">:</span> <span class="mf">0.6977</span>
<span class="p">}</span>

<span class="c1"># üìä Crear DataFrame comparativo</span>
<span class="n">comparacion</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">cv_results</span><span class="p">,</span> <span class="n">holdout_results</span><span class="p">],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Validaci√≥n Cruzada&quot;</span><span class="p">,</span> <span class="s2">&quot;Holdout Externo&quot;</span><span class="p">])</span>
<span class="n">comparacion</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Unexpected exception formatting exception. Falling back to standard exception
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Traceback (most recent call last):
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\formatters.py&quot;, line 223, in catch_format_error
    r = method(self, *args, **kwargs)
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\formatters.py&quot;, line 344, in __call__
    return method()
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\pandas\core\frame.py&quot;, line 1178, in _repr_html_
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\pandas\io\formats\format.py&quot;, line 1074, in to_html
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\pandas\io\formats\html.py&quot;, line 88, in to_string
    lines = self.render()
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\pandas\io\formats\html.py&quot;, line 644, in render
    super().render()
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\pandas\io\formats\html.py&quot;, line 94, in render
    self._write_table()
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\pandas\io\formats\html.py&quot;, line 267, in _write_table
    self._write_header(indent + self.indent_delta)
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\pandas\io\formats\html.py&quot;, line 403, in _write_header
    self._write_col_header(indent + self.indent_delta)
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\pandas\io\formats\html.py&quot;, line 383, in _write_col_header
    row.extend(self._get_columns_formatted_values())
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\pandas\io\formats\html.py&quot;, line 611, in _get_columns_formatted_values
    return self.columns._format_flat(include_name=False)
AttributeError: &#39;Index&#39; object has no attribute &#39;_format_flat&#39;

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\interactiveshell.py&quot;, line 2120, in showtraceback
    stb = self.InteractiveTB.structured_traceback(
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\ultratb.py&quot;, line 1435, in structured_traceback
    return FormattedTB.structured_traceback(
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\ultratb.py&quot;, line 1326, in structured_traceback
    return VerboseTB.structured_traceback(
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\ultratb.py&quot;, line 1173, in structured_traceback
    formatted_exception = self.format_exception_as_a_whole(etype, evalue, etb, number_of_lines_of_context,
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\ultratb.py&quot;, line 1088, in format_exception_as_a_whole
    frames.append(self.format_record(record))
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\ultratb.py&quot;, line 970, in format_record
    frame_info.lines, Colors, self.has_colors, lvals
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\IPython\core\ultratb.py&quot;, line 792, in lines
    return self._sd.lines
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\stack_data\utils.py&quot;, line 145, in cached_property_wrapper
    value = obj.__dict__[self.func.__name__] = self.func(obj)
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\stack_data\core.py&quot;, line 698, in lines
    pieces = self.included_pieces
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\stack_data\utils.py&quot;, line 145, in cached_property_wrapper
    value = obj.__dict__[self.func.__name__] = self.func(obj)
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\stack_data\core.py&quot;, line 649, in included_pieces
    pos = scope_pieces.index(self.executing_piece)
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\stack_data\utils.py&quot;, line 145, in cached_property_wrapper
    value = obj.__dict__[self.func.__name__] = self.func(obj)
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\stack_data\core.py&quot;, line 628, in executing_piece
    return only(
  File &quot;C:\Users\migue\miniconda3\envs\ml_venv\lib\site-packages\executing\executing.py&quot;, line 164, in only
    raise NotOneValueFound(&#39;Expected one value, found 0&#39;)
executing.executing.NotOneValueFound: Expected one value, found 0
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>                      RMSE     MAE      R¬≤   MedAE
Validaci√≥n Cruzada  1.6362  1.0195  0.8833  0.6433
Holdout Externo     1.7320  1.1010  0.8697  0.6977
</pre></div>
</div>
</div>
</div>
<section id="conclusiones-del-modelo-de-regresion-knn">
<h1>üìå Conclusiones del modelo de regresi√≥n KNN<a class="headerlink" href="#conclusiones-del-modelo-de-regresion-knn" title="Link to this heading">#</a></h1>
<ul class="simple">
<li><p>Se evaluaron tres variantes del dataset: <strong>Original</strong>, <strong>Winsorizado</strong> y <strong>Sin Outliers</strong>.<br />
El an√°lisis comparativo con validaci√≥n cruzada (5 splits) mostr√≥ que el dataset <strong>Winsorizado</strong>
con <strong>k=11</strong> obtuvo el mejor equilibrio entre error y capacidad predictiva.</p></li>
<li><p>En validaci√≥n cruzada, el modelo logr√≥:</p>
<ul>
<li><p><strong>RMSE:</strong> 1.6362</p></li>
<li><p><strong>MAE:</strong> 1.0195</p></li>
<li><p><strong>R¬≤:</strong> 0.8833</p></li>
<li><p><strong>MedAE:</strong> 0.6433</p></li>
</ul>
</li>
<li><p>En el <strong>holdout externo</strong> (20% de datos no usados en entrenamiento), los resultados fueron:</p>
<ul>
<li><p><strong>RMSE:</strong> 1.7320</p></li>
<li><p><strong>MAE:</strong> 1.1010</p></li>
<li><p><strong>R¬≤:</strong> 0.8697</p></li>
<li><p><strong>MedAE:</strong> 0.6977</p></li>
</ul>
</li>
<li><p>La ligera ca√≠da en rendimiento entre CV y holdout indica que el modelo mantiene buena capacidad de generalizaci√≥n, sin evidencias de sobreajuste.</p></li>
<li><p>Los an√°lisis gr√°ficos (residuos, QQ-plot y real vs. predicho) muestran que:</p>
<ul>
<li><p>Los errores se distribuyen aproximadamente de forma sim√©trica.</p></li>
<li><p>Existe una relaci√≥n lineal consistente entre valores reales y predichos.</p></li>
<li><p>No se detectan patrones evidentes en los residuos que sugieran problemas de especificaci√≥n del modelo.</p></li>
</ul>
</li>
</ul>
<p>‚úÖ <strong>Conclusi√≥n final:</strong> El modelo KNN con <strong>k=11</strong> entrenado sobre el dataset winsorizado es consistente, estable y adecuado para predecir el promedio final esperado de los estudiantes en este conjunto de datos.</p>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Johan D√≠az, H√©ctor Sanjuan, Miguel Lugo, Luis D. Pe√±aranda
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      ¬© Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>